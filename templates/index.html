<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Board</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #fff;
            color: #1d1d1f;
            min-height: 100vh;
        }

        .hero {
            padding: 64px 24px 48px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.8rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .hero p {
            color: #6e6e73;
            margin-bottom: 24px;
        }

        .bot-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 100px;
            background: #f5f5f7;
            color: #0066cc;
            text-decoration: none;
        }

        #feed {
            max-width: 680px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        .card {
            position: relative;
            display: flex;
            gap: 14px;
            padding: 20px 22px;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 6px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 14px;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            flex: 1;
            min-width: 0;
        }

        .card-meta {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 6px;
        }

        .card-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .card-time {
            position: absolute;
            top: 20px;
            right: 22px;
            font-size: 0.78rem;
            color: #aeaeb2;
        }

        .card-text {
            line-height: 1.55;
            color: #3a3a3c;
            word-break: break-word;
        }

        .card-media {
            margin-top: 10px;
        }

        .card-media img,
        .card-media video {
            max-width: 100%;
            border-radius: 12px;
        }

        .card-media audio {
            width: 100%;
        }

        .document-link {
            display: inline-flex;
            align-items: center;
            padding: 10px 16px;
            background: #f5f5f7;
            border-radius: 8px;
            text-decoration: none;
            color: #0066cc;
        }

        #empty {
            text-align: center;
            padding: 60px 0;
            color: #aeaeb2;
        }

        .dot-flashing {
            display: inline-flex;
            gap: 6px;
        }

        .dot-flashing span {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #c7c7cc;
            animation: blink 1.2s infinite;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: 0.3;
            }

            40% {
                opacity: 1;
            }
        }

        @keyframes rise {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .is-new {
            animation: rise 0.4s ease forwards;
        }
    </style>
</head>

<body>
    <section class="hero">
        <h1>Live Q&A Wall</h1>
        <p>Задайте вопрос боту — он появится на экране.</p>
        <a class="bot-badge" href="https://t.me/LiveWalllbot">@LiveWalllbot</a>
    </section>

    <main id="feed">
        <div id="empty">
            <div class="dot-flashing"><span></span><span></span><span></span></div>
            <p style="margin-top:14px;">Ожидаем сообщения...</p>
        </div>
    </main>

    <script>
        const COLORS = ['#3a86ff', '#8338ec', '#ff006e', '#fb5607', '#06d6a0', '#118ab2'];
        const seen = new Set();
        const feed = document.getElementById('feed');
        const empty = document.getElementById('empty');

        const color = id => COLORS[Math.abs(Number(id) || 0) % COLORS.length];
        const initials = name => name.trim().split(/\s+/).map(w => w[0]).join('').slice(0, 2);
        const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        function prettytime(ts) {
            if (!ts) return '';
            const d = new Date(ts.replace(' ', 'T'));
            if (isNaN(d)) return ts;
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
            if (d.toDateString() === now.toDateString()) return `сегодня в ${time}`;
            return `${d.getDate()} ${['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][d.getMonth()]}, ${time}`;
        }

        function buildCard(msg, fresh) {
            const bg = color(msg.user_id);
            const inits = initials(msg.user_name);
            const avatar = msg.photo_url ? `<img src="${msg.photo_url}">` : inits;
            const card = document.createElement('div');
            card.className = 'card' + (fresh ? ' is-new' : '');

            let media = '';
            if (msg.media_url) {
                if (msg.media_type === 'photo') media = `<div class="card-media"><img src="${msg.media_url}"></div>`;
                else if (msg.media_type === 'video') media = `<div class="card-media"><video src="${msg.media_url}" controls></video></div>`;
                else if (msg.media_type === 'audio') media = `<div class="card-media"><audio src="${msg.media_url}" controls></audio></div>`;
                else media = `<div class="card-media"><a href="${msg.media_url}" class="document-link" download>Скачать файл</a></div>`;
            }

            card.innerHTML = `
                <div class="avatar" style="background:${bg}">${avatar}</div>
                <div class="card-body">
                    <div class="card-meta">
                        <span class="card-name">${esc(msg.user_name)}</span>
                        <span class="card-time">${prettytime(msg.timestamp)}</span>
                    </div>
                    <div class="card-text">${esc(msg.text)}</div>
                    ${media}
                </div>`;
            return card;
        }

        async function poll() {
            try {
                const res = await fetch('/api/messages');
                const data = await res.json();
                if (data.length > 0 && empty) empty.remove();
                data.reverse().forEach(m => {
                    const key = m.timestamp + m.user_id + m.text;
                    if (!seen.has(key)) {
                        const fresh = seen.size > 0;
                        seen.add(key);
                        feed.insertAdjacentElement('afterbegin', buildCard(m, fresh));
                    }
                });
            } catch (e) { }
        }

        setInterval(poll, 3000);
        poll();
    </script>
</body>

</html>