<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #fff;
            color: #1d1d1f;
            min-height: 100vh;
        }

        .hero {
            padding: 48px 24px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.4rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .hero p {
            color: #6e6e73;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .bot-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 100px;
            background: #f5f5f7;
            color: #0066cc;
            text-decoration: none;
            font-size: 0.8rem;
        }

        #feed {
            max-width: 680px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        .card {
            position: relative;
            display: flex;
            gap: 14px;
            padding: 18px;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 6px 16px rgba(0, 0, 0, 0.05);
            margin-bottom: 14px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
            font-size: 0.8rem;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            flex: 1;
            min-width: 0;
        }

        .card-meta {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .card-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .card-time {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 0.7rem;
            color: #aeaeb2;
        }

        .card-text {
            line-height: 1.4;
            color: #3a3a3c;
            word-break: break-word;
            font-size: 0.95rem;
        }

        .card-media {
            margin-top: 10px;
        }

        .card-media img,
        .card-media video {
            max-width: 100%;
            border-radius: 12px;
        }

        .card-media audio {
            width: 100%;
        }

        .document-link {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: #f5f5f7;
            border-radius: 8px;
            text-decoration: none;
            color: #0066cc;
            font-size: 0.85rem;
        }

        #empty {
            text-align: center;
            padding: 40px 0;
            color: #aeaeb2;
            font-size: 0.8rem;
        }

        @keyframes rise {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .is-new {
            animation: rise 0.4s ease forwards;
        }
    </style>
</head>

<body>
    <section class="hero">
        <h1>Live Q&A Wall</h1>
        <p>Задайте вопрос боту — он появится здесь.</p>
        <a class="bot-badge" href="https://t.me/LiveWalllbot">@LiveWalllbot</a>
    </section>
    <main id="feed">
        <div id="empty">Ожидаем вопросы...</div>
    </main>
    <script>
        const COLORS = ['#3a86ff', '#8338ec', '#ff006e', '#fb5607', '#06d6a0', '#118ab2'];
        const seen = new Set();
        const feed = document.getElementById('feed');
        const color = id => COLORS[Math.abs(Number(id) || 0) % COLORS.length];
        const initials = name => name.trim().split(/\s+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
        const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        function prettytime(ts) {
            if (!ts) return '';
            const d = new Date(ts.replace(' ', 'T')), now = new Date();
            const time = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            return d.toDateString() === now.toDateString() ? `сегодня в ${time}` : `${d.getDate()} ${['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][d.getMonth()]} в ${time}`;
        }

        function buildCard(msg, fresh) {
            const mediaUrl = `/api/media/${msg.id}`;
            let media = '';
            if (msg.media_type === 'photo') media = `<div class="card-media"><img src="${mediaUrl}"></div>`;
            else if (msg.media_type === 'video') media = `<div class="card-media"><video src="${mediaUrl}" controls></video></div>`;
            else if (msg.media_type === 'audio') media = `<div class="card-media"><audio src="${mediaUrl}" controls></audio></div>`;
            else if (msg.media_type) media = `<div class="card-media"><a href="${mediaUrl}" class="document-link" download>Файл</a></div>`;

            const card = document.createElement('div');
            card.className = 'card' + (fresh ? ' is-new' : '');
            const av = msg.photo_url ? `<img src="${msg.photo_url}">` : initials(msg.user_name);
            card.innerHTML = `
                <div class="avatar" style="background:${color(msg.user_id)}">${av}</div>
                <div class="card-body">
                    <div class="card-meta"><span class="card-name">${esc(msg.user_name)}</span><span class="card-time">${prettytime(msg.timestamp)}</span></div>
                    <div class="card-text">${esc(msg.text)}</div>
                    ${media}
                </div>`;
            return card;
        }

        async function poll() {
            try {
                const res = await fetch('/api/messages'), data = await res.json();
                if (data.length > 0 && document.getElementById('empty')) document.getElementById('empty').remove();
                data.reverse().forEach(m => {
                    if (!seen.has(m.id)) {
                        const fresh = seen.size > 0;
                        seen.add(m.id);
                        feed.insertAdjacentElement('afterbegin', buildCard(m, fresh));
                    }
                });
            } catch (e) { }
        }
        setInterval(poll, 3000); poll();
    </script>
</body>

</html>